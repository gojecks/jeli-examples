(function(){"use strict";function e(e){function t(t,n,c){function s(){this.onSuccess=function(e){switch(e.state){case"insert":case"sync":break;case"select":}},this.onError=function(){console.log(ret)}}function o(){function t(){if(c.chat.userConnected){var e=c.chat.chatList;r.get("chat",{$hash:e.length}).then(function(e){e.jDBNumRows()?(c.chat.chatList.push.apply(c.chat.chatList,e.getResult()),h=2e3):h+=30,setTimeout(t,h)})}}e.getItem(a)&&(c.chat.username=e.getItem(a),c.chat.userConnected=!0,u.jCMD("select -* -chat",{onSuccess:function(e){c.chat.chatList=e.getResult()},onError:function(e){console.log(e)}}),t())}function i(){e.setItem(a,c.chat.username),o()}var a="_chat_rec_",u=null,r={},h=2e3;new jEli.$jDB("jChatService",1).isClientMode().open({serviceHost:"http://172.31.98.110/jEliDB/",logService:function(){},live:!0}).onSuccess(function(e){u=e.result,r=u.synchronize().Entity().configSync({})}),c.chat={username:"",userConnected:!1,chatList:[]},c.$create=function(){c.chat.username&&r.get("_users",{key:c.chat.username}).then(function(e){e.jDBNumRows()?i():u._users().add({key:c.chat.username,password:"_null"}).onSuccess(function(e){e.ok&&i()}).onError(function(){})})},c.$postChat=function(e){var t=jEli.dom(e.currentTarget);if(13===e.keyCode&&t.length&&t.val()){var n=[{message:t.val(),time:+new Date,user:c.chat.username}];u.jCMD("insert -"+JSON.stringify(n)+" -chat",new s),t.val("")}},c.$disconnect=function(){e.removeItem(a),c.chat.userConnected=!1},o()}return{$init:t}}jEli.jModule("chat.service",["jEli.Date.Time"]).jElement("chatApp",["$sessionStorage",e])})();